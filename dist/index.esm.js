/*! For license information please see index.esm.js.LICENSE.txt */
import{default as t}from"ol/source/DataTile";import{default as e}from"ol/tilegrid/TileGrid";import{openArray as r}from"zarr";var n={27:(n,a,i)=>{function o(t){return o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},o(t)}function s(){var t,e,r="function"==typeof Symbol?Symbol:{},n=r.iterator||"@@iterator",a=r.toStringTag||"@@toStringTag";function i(r,n,a,i){var s=n&&n.prototype instanceof c?n:c,l=Object.create(s.prototype);return u(l,"_invoke",function(r,n,a){var i,s,u,c=0,l=a||[],m=!1,f={p:0,n:0,v:t,a:d,f:d.bind(t,4),d:function(e,r){return i=e,s=0,u=t,f.n=r,o}};function d(r,n){for(s=r,u=n,e=0;!m&&c&&!a&&e<l.length;e++){var a,i=l[e],d=f.p,h=i[2];r>3?(a=h===n)&&(u=i[(s=i[4])?5:(s=3,3)],i[4]=i[5]=t):i[0]<=d&&((a=r<2&&d<i[1])?(s=0,f.v=n,f.n=i[1]):d<h&&(a=r<3||i[0]>n||n>h)&&(i[4]=r,i[5]=n,f.n=h,s=0))}if(a||r>1)return o;throw m=!0,n}return function(a,l,h){if(c>1)throw TypeError("Generator is already running");for(m&&1===l&&d(l,h),s=l,u=h;(e=s<2?t:u)||!m;){i||(s?s<3?(s>1&&(f.n=-1),d(s,u)):f.n=u:f.v=u);try{if(c=2,i){if(s||(a="next"),e=i[a]){if(!(e=e.call(i,u)))throw TypeError("iterator result is not an object");if(!e.done)return e;u=e.value,s<2&&(s=0)}else 1===s&&(e=i.return)&&e.call(i),s<2&&(u=TypeError("The iterator does not provide a '"+a+"' method"),s=1);i=t}else if((e=(m=f.n<0)?u:r.call(n,f))!==o)break}catch(e){i=t,s=1,u=e}finally{c=1}}return{value:e,done:m}}}(r,a,i),!0),l}var o={};function c(){}function l(){}function m(){}e=Object.getPrototypeOf;var f=[][n]?e(e([][n]())):(u(e={},n,function(){return this}),e),d=m.prototype=c.prototype=Object.create(f);function h(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,m):(t.__proto__=m,u(t,a,"GeneratorFunction")),t.prototype=Object.create(d),t}return l.prototype=m,u(d,"constructor",m),u(m,"constructor",l),l.displayName="GeneratorFunction",u(m,a,"GeneratorFunction"),u(d),u(d,a,"Generator"),u(d,n,function(){return this}),u(d,"toString",function(){return"[object Generator]"}),(s=function(){return{w:i,m:h}})()}function u(t,e,r,n){var a=Object.defineProperty;try{a({},"",{})}catch(t){a=0}u=function(t,e,r,n){function i(e,r){u(t,e,function(t){return this._invoke(e,r,t)})}e?a?a(t,e,{value:r,enumerable:!n,configurable:!n,writable:!n}):t[e]=r:(i("next",0),i("throw",1),i("return",2))},u(t,e,r,n)}function c(t,e,r,n,a,i,o){try{var s=t[i](o),u=s.value}catch(t){return void r(t)}s.done?e(u):Promise.resolve(u).then(n,a)}function l(t){return function(){var e=this,r=arguments;return new Promise(function(n,a){var i=t.apply(e,r);function o(t){c(i,n,a,o,s,"next",t)}function s(t){c(i,n,a,o,s,"throw",t)}o(void 0)})}}function m(t){return function(t){if(Array.isArray(t))return f(t)}(t)||function(t){if("undefined"!=typeof Symbol&&null!=t[Symbol.iterator]||null!=t["@@iterator"])return Array.from(t)}(t)||function(t,e){if(t){if("string"==typeof t)return f(t,e);var r={}.toString.call(t).slice(8,-1);return"Object"===r&&t.constructor&&(r=t.constructor.name),"Map"===r||"Set"===r?Array.from(t):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?f(t,e):void 0}}(t)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function f(t,e){(null==e||e>t.length)&&(e=t.length);for(var r=0,n=Array(e);r<e;r++)n[r]=t[r];return n}function d(t,e){for(var r=0;r<e.length;r++){var n=e[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,h(n.key),n)}}function h(t){var e=function(t){if("object"!=o(t)||!t)return t;var e=t[Symbol.toPrimitive];if(void 0!==e){var r=e.call(t,"string");if("object"!=o(r))return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(t);return"symbol"==o(e)?e:e+""}function p(){try{var t=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(t){}return(p=function(){return!!t})()}function y(t){return y=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(t){return t.__proto__||Object.getPrototypeOf(t)},y(t)}function v(t,e){return v=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,e){return t.__proto__=e,t},v(t,e)}i.d(a,{E:()=>_,A:()=>b});const _=function(){function n(t){var r;if(function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,n),null==t||!t.metadata)throw new Error("Metadata is required for ZarrTile source");if(!t.metadata.url)throw new Error("URL is required in ZarrTile metadata");var a=t.metadata,i=a.extent,u=a.zoomLevels,c=a.resolutions,f=a.crs,d=a.bandIndices,h=a.currentTime,v=a.nodata,_=a.path,b=void 0===_?"":_,g=a.arrayPaths,x=void 0===g?{value:"value",time:"time",statistics:"statistics"}:g;if(!(i&&u&&c&&f))throw new Error("Missing required metadata: extent, zoomLevels, resolutions, and crs are required");var w,T=n._generateFullArrays(c,u),I=new e({extent:i,resolutions:T,minZoom:Math.min.apply(Math,m(u)),maxZoom:Math.max.apply(Math,m(u))});return r=function(t,e,r){return e=y(e),function(t,e){if(e&&("object"==o(e)||"function"==typeof e))return e;if(void 0!==e)throw new TypeError("Derived constructors may only return object or undefined");return function(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(t)}(t,p()?Reflect.construct(e,r||[],y(t).constructor):e.apply(t,r))}(this,n,[{projection:f,tileGrid:I,interpolate:void 0===t.interpolate||t.interpolate,transition:t.transition||0,wrapX:void 0!==t.wrapX&&t.wrapX,loader:(w=l(s().m(function t(e,n,a){return s().w(function(t){for(;;)switch(t.n){case 0:return t.n=1,r.tileLoader(e,n,a);case 1:return t.a(2,t.v)}},t)})),function(t,e,r){return w.apply(this,arguments)})}]),r.url_=r._normalizeUrl(t.metadata.url),r.path_=b,r.arrayPaths_=x,r.metadata_=t.metadata,r.bandIndices_=d||[0],r.bandIndex_=t.bandIndex||0,r.timestamps_=t.metadata.timestamps||[],r.statistics_=t.metadata.statistics||[],r.nodata_=v,r.usePercentiles_=void 0===t.metadata.usePercentiles||t.metadata.usePercentiles,r.currentTimeIndex_=0,h&&r.timestamps_.length>0?r.currentTimeIndex_=r._findClosestTimestampIndex(h):void 0!==t.timeIndex&&(r.currentTimeIndex_=Math.max(0,Math.min(t.timeIndex,r.timestamps_.length-1))),r.addChangeListener("time",function(){return r.refresh()}),r.addChangeListener("bands",function(){return r.refresh()}),r.timestamps_.length>0&&r.set("time",r.timestamps_[r.currentTimeIndex_]),r.set("bands",r.bandIndices_),r}return function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),Object.defineProperty(t,"prototype",{writable:!1}),e&&v(t,e)}(n,t),a=n,u=[{key:"_normalizeUrl",value:function(t){return t.replace(/\/+$/,"")}},{key:"getZoomUrl",value:function(t){return"".concat(this.url_,"/").concat(this.path_,"/").concat(t).replace(/\/+/g,"/")}},{key:"getValueArrayUrl",value:function(t){return"".concat(this.getZoomUrl(t),"/").concat(this.arrayPaths_.value)}},{key:"isZoomSupported",value:function(t){return this.metadata_.zoomLevels.includes(t)}},{key:"tileLoader",value:(_=l(s().m(function t(e,r,n){var a,o,u,c=this;return s().w(function(t){for(;;)switch(t.n){case 0:if(this.isZoomSupported(e)){t.n=1;break}return t.a(2,void 0);case 1:return a=this.getTileGrid(),o=a.getTileSize(e),u=a.getFullTileRange(e),t.a(2,new Promise(function(t,a){var s;try{s=new URL("zarr-worker.js",i.p)}catch(t){s="zarr-worker.js"}var l=new Worker(s,{type:"module"});l.onmessage=function(e){l.terminate(),e.data.error?a(new Error(e.data.error)):t(e.data.tileData)},l.onerror=function(t){l.terminate(),a(t)},l.postMessage({z:e,x:r,y:n,tileSize:o,tileRange:u,bands:c.bandIndices_,bandIndex:c.bandIndex_,timeIndex:c.currentTimeIndex_,nodata:c.nodata_,normalize:c.metadata_.normalize||!1,statistics:c.getCurrentStatistics(),usePercentiles:c.usePercentiles_,storeUrl:c.url_,storePath:c.getValueArrayUrl(e)})}))}},t,this)})),function(t,e,r){return _.apply(this,arguments)})},{key:"retrieveTimestamps",value:(h=l(s().m(function t(){var e,n,a,i;return s().w(function(t){for(;;)switch(t.p=t.n){case 0:if(!(this.timestamps_.length>0)){t.n=1;break}return t.a(2);case 1:return e=[],t.p=2,n=Math.max.apply(Math,m(this.metadata_.zoomLevels)),t.n=3,r({store:this.url_,path:"".concat(this.path_,"/").concat(n,"/").concat(this.arrayPaths_.time).replace(/\/+/g,"/"),mode:"r"});case 3:return a=t.v,t.n=4,a.get([null]);case 4:t.v.data.forEach(function(t){e.push(new Date(1e3*t))}),this.timestamps_=e,e.length>0&&this.currentTimeIndex_>=e.length&&(this.currentTimeIndex_=e.length-1),t.n=6;break;case 5:t.p=5,i=t.v,console.warn("Could not retrieve timestamps:",i.message);case 6:return t.a(2)}},t,this,[[2,5]])})),function(){return h.apply(this,arguments)})},{key:"retrieveStatistics",value:(f=l(s().m(function t(){var e,n,a,i;return s().w(function(t){for(;;)switch(t.p=t.n){case 0:if(!(this.statistics_.length>0)){t.n=1;break}return t.a(2);case 1:return e=[],t.p=2,n=Math.max.apply(Math,m(this.metadata_.zoomLevels)),t.n=3,r({store:this.url_,path:"".concat(this.path_,"/").concat(n,"/").concat(this.arrayPaths_.statistics).replace(/\/+/g,"/"),mode:"r"});case 3:return a=t.v,t.n=4,a.get([null,this.bandIndex_,null]);case 4:t.v.data.forEach(function(t){e.push({min:t[0],max:t[1],mean:t[2],p2:t[3],p98:t[4],mode:t[5],std:t[6]})}),this.statistics_=e,t.n=6;break;case 5:t.p=5,i=t.v,console.warn("Could not retrieve statistics:",i.message);case 6:return t.a(2)}},t,this,[[2,5]])})),function(){return f.apply(this,arguments)})},{key:"getCurrentStatistics",value:function(){if(0===this.statistics_.length)return null;var t=Math.min(this.currentTimeIndex_,this.statistics_.length-1);return this.statistics_[t]}},{key:"_findClosestTimestampIndex",value:function(t){if(0===this.timestamps_.length)return 0;for(var e=0,r=Math.abs(this.timestamps_[0].getTime()-t.getTime()),n=1;n<this.timestamps_.length;n++){var a=Math.abs(this.timestamps_[n].getTime()-t.getTime());a<r&&(r=a,e=n)}return e}},{key:"getTimeRangeIndices",value:function(t,e){for(var r=t.getTime(),n=e.getTime(),a=-1,i=-1,o=0;o<this.timestamps_.length;o++){var s=this.timestamps_[o].getTime();if(-1===a&&s>=r&&(a=o),s>n){i=o-1;break}s<=n&&(i=o)}return{startIndex:-1===a?0:a,endIndex:-1===i?this.timestamps_.length-1:i}}},{key:"getIndicesFromCoord",value:function(t){var e=this.metadata_.resolutions[this.metadata_.resolutions.length-1],r=this.metadata_.extent,n=Math.max(r[0],Math.min(t[0],r[2])),a=Math.max(r[1],Math.min(t[1],r[3]));return[Math.floor((n-r[0])/e),Math.floor((r[3]-a)/e)]}},{key:"getCoordinateAtIndex",value:function(t,e){var r=this.metadata_.extent,n=this.metadata_.resolutions[this.metadata_.resolutions.length-1];return[t*n+r[0],r[3]-e*n]}},{key:"getIndicesFromExtent",value:function(t){var e=this.metadata_.resolutions[this.metadata_.resolutions.length-1],r=this.metadata_.extent,n=Math.max(t[0],r[0]),a=Math.min(t[2],r[2]),i=Math.max(t[1],r[1]),o=Math.min(t[3],r[3]);return[Math.floor((n-r[0])/e),Math.floor((r[3]-o)/e),Math.floor((a-r[0])/e),Math.floor((r[3]-i)/e)]}},{key:"getExtentFromIndices",value:function(t,e,r,n){var a=this.metadata_.resolutions[this.metadata_.resolutions.length-1],i=this.metadata_.extent,o=t*a+i[0],s=i[3]-e*a,u=r*a+i[0];return[o,i[3]-n*a,u,s]}},{key:"getUrl",value:function(){return this.url_}},{key:"getMetadata",value:function(){return this.metadata_}},{key:"getBandIndex",value:function(){return this.bandIndex_}},{key:"setBandIndex",value:function(t){t!==this.bandIndex_&&t>=0&&t<this.bandIndices_.length&&(this.bandIndex_=t,this.set("bands",this.bandIndices_),this.refresh())}},{key:"getTimeIndex",value:function(){return this.currentTimeIndex_}},{key:"setTimeIndex",value:function(t){t!==this.currentTimeIndex_&&t>=0&&t<this.timestamps_.length&&(this.currentTimeIndex_=t,this.set("time",this.timestamps_[this.currentTimeIndex_]),this.refresh())}},{key:"setCurrentTime",value:function(t){var e=this._findClosestTimestampIndex(t);this.setTimeIndex(e)}},{key:"getTimestamps",value:function(){return this.timestamps_}},{key:"getTimeAtIndex",value:function(t){return this.timestamps_[t]||null}},{key:"getIndexAtTime",value:function(t){return this._findClosestTimestampIndex(t)}},{key:"getCurrentTimeIndex",value:function(){return this.currentTimeIndex_}}],c=[{key:"_generateFullArrays",value:function(t,e){var r=Math.max.apply(Math,m(e)),n=Math.min.apply(Math,m(e)),a=new Array(r+1);e.forEach(function(e,r){a[e]=t[r]});for(var i=0;i<=r;i++)if(void 0===a[i])if(i<n)a[i]=t[0]+.001*(n-i);else{for(var o=-1,s=0;s<e.length;s++)if(e[s]>i){o=s;break}if(-1===o)a[i]=t[t.length-1];else{var u=o-1;if(u>=0){var c=e[u],l=(i-c)/(e[o]-c),f=t[u]+(t[o]-t[u])*l;a[i]=f+.001*(i-c)}else a[i]=t[o]}}return a[0]=a[0]+.5,a}}],u&&d(a.prototype,u),c&&d(a,c),Object.defineProperty(a,"prototype",{writable:!1}),a;var a,u,c,f,h,_}();n=i.hmd(n);const b=_;n.exports&&(n.exports=_,n.exports.ZarrTile=_,n.exports.default=_)}},a={};function i(t){var e=a[t];if(void 0!==e)return e.exports;var r=a[t]={id:t,loaded:!1,exports:{}};return n[t](r,r.exports,i),r.loaded=!0,r.exports}i.d=(t,e)=>{for(var r in e)i.o(e,r)&&!i.o(t,r)&&Object.defineProperty(t,r,{enumerable:!0,get:e[r]})},i.hmd=t=>((t=Object.create(t)).children||(t.children=[]),Object.defineProperty(t,"exports",{enumerable:!0,set:()=>{throw new Error("ES Modules may not assign module.exports or exports.*, Use ESM export syntax, instead: "+t.id)}}),t),i.o=(t,e)=>Object.prototype.hasOwnProperty.call(t,e),(()=>{var t;if("string"==typeof import.meta.url&&(t=import.meta.url),!t)throw new Error("Automatic publicPath is not supported in this browser");t=t.replace(/^blob:/,"").replace(/#.*$/,"").replace(/\?.*$/,"").replace(/\/[^\/]+$/,"/"),i.p=t})();var o=i(27);const s=o.E,u=o.A;export{s as ZarrTile,u as default};